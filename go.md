# Go Development Guide

This document provides comprehensive guidance for working with Go in the otelcol-custom project.

**_Note_** This documentation is generated by Claude, this documentation isn't verified.

## Table of Contents
- [Prerequisites](#prerequisites)
- [Installing Go](#installing-go)
- [Updating Go](#updating-go)
- [Project Setup](#project-setup)
- [Building the Collector](#building-the-collector)
- [Development Workflow](#development-workflow)
- [Troubleshooting](#troubleshooting)
- [Go Modules](#go-modules)
- [Best Practices](#best-practices)

## Prerequisites

This project requires:
- **Go version**: 1.24.0 or higher (as specified in [go.mod](go.mod))
- **Toolchain**: go1.24.9
- **Operating System**: Linux (primary), macOS, or Windows

## Installing Go

### Linux Installation

1. **Download Go** from the [official Go downloads page](https://go.dev/dl/)
   ```bash
   # Download the latest version (replace with current version)
   wget https://go.dev/dl/go1.24.9.linux-amd64.tar.gz
   ```

2. **Remove any existing Go installation**
   ```bash
   sudo rm -rf /usr/local/go
   ```

3. **Extract the archive to /usr/local**
   ```bash
   sudo tar -C /usr/local -xzf go1.24.9.linux-amd64.tar.gz
   ```

4. **Add Go to your PATH**

   Add the following to your `~/.bashrc`, `~/.zshrc`, or `~/.profile`:
   ```bash
   export PATH=$PATH:/usr/local/go/bin
   export GOPATH=$HOME/go
   export PATH=$PATH:$GOPATH/bin
   ```

5. **Apply the changes**
   ```bash
   source ~/.bashrc  # or ~/.zshrc or ~/.profile
   ```

6. **Verify the installation**
   ```bash
   go version
   # Should output: go version go1.24.9 linux/amd64
   ```

### macOS Installation

Using Homebrew:
```bash
brew install go@1.24
```

Or download the `.pkg` installer from [go.dev/dl](https://go.dev/dl/)

### Windows Installation

Download the `.msi` installer from [go.dev/dl](https://go.dev/dl/) and follow the installation wizard.

## Updating Go

### Method 1: Clean Installation (Recommended)

1. **Determine where the current Go installation is located**
   ```bash
   which go
   # Output: /usr/local/go/bin/go
   ```

2. **Remove the old Go installation**
   ```bash
   sudo rm -rf /usr/local/go
   ```

3. **Download and install the new version**
   ```bash
   # Download the latest version
   wget https://go.dev/dl/go1.24.9.linux-amd64.tar.gz

   # Extract to /usr/local
   sudo tar -C /usr/local -xzf go1.24.9.linux-amd64.tar.gz
   ```

4. **Verify the update**
   ```bash
   go version
   ```

### Method 2: Using Go's Built-in Update (Go 1.20+)

```bash
go install golang.org/dl/go1.24.9@latest
go1.24.9 download
```

## Project Setup

### Initial Setup

1. **Clone the repository** (if not already done)
   ```bash
   git clone https://github.com/battalion-energy/otelcol-custom.git
   cd otelcol-custom
   ```

2. **Download dependencies**
   ```bash
   go mod download
   ```

3. **Verify dependencies**
   ```bash
   go mod verify
   ```

### Environment Variables

Set these environment variables for optimal development:

```bash
# Enable Go modules (default in Go 1.16+)
export GO111MODULE=on

# Set GOPROXY for faster downloads
export GOPROXY=https://proxy.golang.org,direct

# Disable CGO if not needed (for static binaries)
export CGO_ENABLED=0
```

## Building the Collector

### Quick Build

Using the Makefile:
```bash
make build
```

This will:
1. Run the OpenTelemetry Collector Builder with [builder-config.yaml](builder-config.yaml)
2. Generate component code in the `dist/` directory
3. Compile the binary

### Manual Build Process

1. **Generate collector code**
   ```bash
   go run go.opentelemetry.io/collector/cmd/builder@latest --config builder-config.yaml
   ```

2. **Build the binary**
   ```bash
   cd dist
   go build -o otelcol .
   ```

3. **Build with optimizations** (smaller binary size)
   ```bash
   cd dist
   go build -ldflags="-s -w" -o otelcol-custom .
   ```

   Flags explained:
   - `-s`: Omit symbol table and debug information
   - `-w`: Omit DWARF symbol table

### Platform-Specific Builds

**Linux AMD64:**
```bash
make build-linux-amd64
# Or manually:
cd dist && GOOS=linux GOARCH=amd64 go build -o otelcol-linux-amd64 .
```

**Linux ARM64:**
```bash
make build-linux-arm64
# Or manually:
cd dist && GOOS=linux GOARCH=arm64 go build -o otelcol-linux-arm64 .
```

**Other platforms:**
```bash
# macOS ARM64 (Apple Silicon)
GOOS=darwin GOARCH=arm64 go build -o otelcol-darwin-arm64 .

# Windows AMD64
GOOS=windows GOARCH=amd64 go build -o otelcol-windows-amd64.exe .
```

### Static Binary Build

For deployment in minimal containers (e.g., Alpine, scratch):

```bash
cd dist
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
  -ldflags="-s -w -extldflags '-static'" \
  -tags netgo \
  -o otelcol-static .
```

## Development Workflow

### 1. Regenerating Components

After modifying [builder-config.yaml](builder-config.yaml):

```bash
make generate
```

Or:
```bash
go run go.opentelemetry.io/collector/cmd/builder@latest --config builder-config.yaml
```

### 2. Adding New Components

Edit [builder-config.yaml](builder-config.yaml) to add receivers, processors, exporters, or connectors:

```yaml
receivers:
  - gomod: github.com/open-telemetry/opentelemetry-collector-contrib/receiver/nginxreceiver v0.127.0
```

Then regenerate:
```bash
make generate
go mod tidy
make build
```

### 3. Updating Dependencies

Update all dependencies:
```bash
go get -u ./...
go mod tidy
```

Update specific dependency:
```bash
go get go.opentelemetry.io/collector/otelcol@latest
go mod tidy
```

Update OpenTelemetry Collector version:
```bash
# Update to specific version
go get go.opentelemetry.io/collector/otelcol@v0.137.0
go mod tidy
```

### 4. Running Tests

```bash
# Run all tests
go test ./...

# Run tests with verbose output
go test -v ./...

# Run tests with coverage
go test -cover ./...

# Generate coverage report
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out
```

### 5. Linting and Formatting

```bash
# Format code
go fmt ./...

# Run go vet
go vet ./...

# Install and run golangci-lint (recommended)
go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
golangci-lint run
```

## Troubleshooting

### Common Issues

#### 1. "go: module not found" or "package not found"

**Solution:**
```bash
go mod download
go mod verify
go mod tidy
```

#### 2. "build constraints exclude all Go files"

This usually means you're building for the wrong platform or architecture.

**Solution:**
```bash
# Check current platform
go env GOOS GOARCH

# Build for current platform explicitly
GOOS=$(go env GOOS) GOARCH=$(go env GOARCH) go build
```

#### 3. "collector builder fails"

**Solution:**
```bash
# Clean and regenerate
rm -rf dist/
go run go.opentelemetry.io/collector/cmd/builder@latest --config builder-config.yaml
```

#### 4. "out of memory" during build

**Solution:**
```bash
# Limit parallel compilation
go build -p 1 .

# Or increase system resources
```

#### 5. Version mismatch errors

**Solution:**
```bash
# Clean module cache
go clean -modcache

# Re-download dependencies
go mod download
```

### Debugging Build Issues

Enable verbose output:
```bash
go build -v .
```

Show compiler optimization decisions:
```bash
go build -gcflags="-m" .
```

Debug linker:
```bash
go build -ldflags="-v" .
```

## Go Modules

### Understanding go.mod

The [go.mod](go.mod) file specifies:
- **Module path**: `github.com/battalion/otelcol`
- **Go version**: `1.24.0`
- **Toolchain**: `go1.24.9`
- **Dependencies**: Direct and indirect dependencies

### Key Dependencies

**Direct dependencies:**
- `go.opentelemetry.io/collector/cmd/builder` - Collector builder tool
- `go.opentelemetry.io/collector/component` - Component interfaces
- `go.opentelemetry.io/collector/confmap` - Configuration mapping
- `go.opentelemetry.io/collector/otelcol` - Core collector

### Module Commands

```bash
# Show module info
go list -m all

# Show why a package is needed
go mod why github.com/prometheus/client_golang

# Show dependency graph
go mod graph

# Prune unused dependencies
go mod tidy

# Verify dependencies
go mod verify

# Download dependencies to local cache
go mod download
```

## Best Practices

### 1. Keep Go Updated

Regularly update to the latest patch version for security fixes:
```bash
# Check for updates
go version

# Update Go installation (Linux)
sudo rm -rf /usr/local/go
wget https://go.dev/dl/go1.24.9.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.24.9.linux-amd64.tar.gz
```

### 2. Use Make Targets

Prefer using Makefile targets for consistency:
```bash
make build        # Standard build
make generate     # Regenerate components
make clean        # Clean build artifacts
```

### 3. Version Control

Never commit these files/directories:
- `dist/` - Generated code
- `otelcol-custom` - Built binary
- `*.test` - Test binaries
- `coverage.out` - Coverage reports

These are already in [.gitignore](.gitignore).

### 4. Reproducible Builds

Always specify exact versions in [builder-config.yaml](builder-config.yaml):
```yaml
# Good
- gomod: github.com/open-telemetry/opentelemetry-collector-contrib/receiver/hostmetricsreceiver v0.127.0

# Avoid
- gomod: github.com/open-telemetry/opentelemetry-collector-contrib/receiver/hostmetricsreceiver
```

### 5. Testing Before Commits

```bash
# Run the full test suite
go test ./...

# Format code
go fmt ./...

# Run linter
go vet ./...

# Build to verify
make build
```

## Additional Resources

- [Official Go Documentation](https://go.dev/doc/)
- [Go Modules Reference](https://go.dev/ref/mod)
- [OpenTelemetry Collector Builder](https://github.com/open-telemetry/opentelemetry-collector/tree/main/cmd/builder)
- [OpenTelemetry Collector Documentation](https://opentelemetry.io/docs/collector/)
- [Effective Go](https://go.dev/doc/effective_go)

## Project-Specific Notes

- This project uses Go 1.24.0+ for latest OpenTelemetry Collector support
- The `dist/` directory is auto-generated and should not be manually edited
- All custom logic should be in configuration files, not in generated code
- See [README.md](README.md) for high-level project documentation
- See [builder-config.yaml](builder-config.yaml) for component configuration
